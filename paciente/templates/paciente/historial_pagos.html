{% extends "paciente/dashboard_base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üí∞ Historial de Pagos</h2>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="fecha_desde" class="form-label">Fecha Desde</label>
                    <input type="date" class="form-control" id="fecha_desde" name="fecha_desde"
                           value="{{ fecha_desde }}">
                </div>
                <div class="col-md-4">
                    <label for="fecha_hasta" class="form-label">Fecha Hasta</label>
                    <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta"
                           value="{{ fecha_hasta }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Filtrar</button>
                    <a href="{% url 'historial_pagos_paciente' %}" class="btn btn-secondary">Limpiar</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumen -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <h5 class="card-title text-primary">${{ total_consultas|floatformat:2 }}</h5>
                    <p class="card-text">Consultas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <h5 class="card-title text-success">${{ total_gastos|floatformat:2 }}</h5>
                    <p class="card-text">Gastos Adicionales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">${{ total_general|floatformat:2 }}</h5>
                    <p class="card-text">Total General</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <h5 class="card-title text-warning">{{ total_pagos }}</h5>
                    <p class="card-text">Total Pagos</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de pagos -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">Pagos Realizados</h5>
        </div>
        <div class="card-body">
            {% if pagos %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>M√©dico</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>M√©todo de Pago</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pago in pagos %}
                                <tr>
                                    <td>{{ pago.fecha|date:"d/m/Y" }}</td>
                                    <td>{{ pago.medico }}</td>
                                    <td>
                                        {% if pago.tipo == 'consulta' %}
                                            <span class="badge bg-primary">Consulta</span>
                                        {% else %}
                                            <span class="badge bg-success">Gasto Adicional</span>
                                        {% endif %}
                                        {{ pago.descripcion }}
                                    </td>
                                    <td>${{ pago.monto|floatformat:2 }}</td>
                                    <td>{{ pago.metodo_pago }}</td>
                                    <td>
                                        {% if pago.estado == 'Completado' %}
                                            <span class="badge bg-success">{{ pago.estado }}</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">{{ pago.estado }}</span>
                                            {% if pago.metodo_pago == 'Tarjeta' %}
                                                {% if pago.tipo == 'consulta' %}
                                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#pagarModal"
                                                            data-tipo="consulta" data-id="{{ pago.cita_id }}" data-monto="{{ pago.monto }}">
                                                        <i class="fas fa-credit-card"></i> Pagar
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#pagarModal"
                                                            data-tipo="gasto" data-id="{{ pago.gasto_id }}" data-monto="{{ pago.monto }}">
                                                        <i class="fas fa-credit-card"></i> Pagar
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
<!-- Modal para pago con tarjeta -->
<div class="modal fade" id="pagarModal" tabindex="-1" aria-labelledby="pagarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pagarModalLabel">Pagar con Tarjeta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="pagoForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Monto a pagar: $<span id="montoPagar"></span></strong>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="numero_tarjeta_modal" class="form-label">N√∫mero de tarjeta</label>
                            <input type="text" name="numero_tarjeta" id="numero_tarjeta_modal" class="form-control" maxlength="16" placeholder="1234567890123456" required>
                        </div>
                        <div class="col-md-3">
                            <label for="fecha_expiracion_modal" class="form-label">Fecha expiraci√≥n</label>
                            <input type="text" name="fecha_expiracion" id="fecha_expiracion_modal" class="form-control" placeholder="MM/YY" maxlength="5" required>
                        </div>
                        <div class="col-md-3">
                            <label for="cvv_modal" class="form-label">CVV</label>
                            <input type="text" name="cvv" id="cvv_modal" class="form-control" maxlength="4" placeholder="123" required>
                        </div>
                        <div class="col-md-6">
                            <label for="nombre_titular_modal" class="form-label">Nombre del titular</label>
                            <input type="text" name="nombre_titular" id="nombre_titular_modal" class="form-control" placeholder="Como aparece en la tarjeta" required>
                        </div>
                        <div class="col-md-6">
                            <label for="tipo_tarjeta_modal" class="form-label">Tipo de tarjeta</label>
                            <select name="tipo_tarjeta" id="tipo_tarjeta_modal" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="debito">D√©bito</option>
                                <option value="credito">Cr√©dito</option>
                            </select>
                        </div>
                    </div>

                    <input type="hidden" name="tipo_pago" id="tipoPagoInput">
                    <input type="hidden" name="id_pago" id="idPagoInput">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-credit-card me-2"></i>Procesar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pagarModal = document.getElementById('pagarModal');
    const montoSpan = document.getElementById('montoPagar');
    const tipoPagoInput = document.getElementById('tipoPagoInput');
    const idPagoInput = document.getElementById('idPagoInput');
    const pagoForm = document.getElementById('pagoForm');

    // Manejar apertura del modal
    pagarModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const tipo = button.getAttribute('data-tipo');
        const id = button.getAttribute('data-id');
        const monto = button.getAttribute('data-monto');

        montoSpan.textContent = monto;
        tipoPagoInput.value = tipo;
        idPagoInput.value = id;

        // Cambiar action del form seg√∫n el tipo
        if (tipo === 'consulta') {
            pagoForm.action = `/paciente/pagar-consulta/${id}/`;
        } else {
            pagoForm.action = `/paciente/pagar-gasto/${id}/`;
        }
    });

    // Formatear fecha de expiraci√≥n
    document.getElementById('fecha_expiracion_modal').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });

    // Validar n√∫mero de tarjeta (solo n√∫meros)
    document.getElementById('numero_tarjeta_modal').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });

    // Validar CVV (solo n√∫meros)
    document.getElementById('cvv_modal').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });
});
</script>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-receipt text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">No hay pagos registrados</h5>
                    <p class="text-muted">Los pagos realizados aparecer√°n aqu√≠ una vez que sean completados.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-4">
        <a href="{% url 'dashboard_paciente' %}" class="btn btn-secondary">Volver al Dashboard</a>
    </div>
</div>
{% endblock %}