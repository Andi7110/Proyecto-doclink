{% extends "paciente/dashboard_base.html" %}
{% load static %}

{% block content %}

<div class="container">
    

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" class="row g-3">
        {% csrf_token %}

        <!-- Datos del paciente y cita -->
        <div class="col-md-7">
            <!-- Datos personales -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Tus Datos</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre Completo</label>
                        <input type="text" id="nombre" class="form-control" value="{{ nombre }}" readonly>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edad" class="form-label">Edad</label>
                            <input type="text" id="edad" class="form-control" 
                                   value="{% if edad %}{{ edad }} años{% else %}No especificada{% endif %}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sexo" class="form-label">Sexo</label>
                            <input type="text" id="sexo" class="form-control" 
                                   value="{% if sexo %}{{ sexo }}{% else %}No especificado{% endif %}" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalles de la cita -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-stethoscope me-2"></i>Detalles de la Cita</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4 p-3 bg-light rounded">
                        <h6 class="fw-bold">Médico seleccionado:</h6>
                        <p id="medico-seleccionado-texto" class="fs-5 mb-2">
                            {% if medico_nombre %}
                                <strong>{{ medico_nombre }}</strong>
                            {% else %}
                                <span class="text-muted">Ningún médico seleccionado</span>
                            {% endif %}
                        </p>
                        <input type="hidden" name="medico_id" id="medico_id" value="{{ medico_id|default:'' }}">
                        <div id="alerta-precio" class="alert alert-warning d-none mt-2"></div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="fecha_cita" class="form-label">Fecha</label>
                            <input type="date" name="fecha_cita" id="fecha_cita" class="form-control" required min="{{ hoy|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="hora_cita" class="form-label">Hora</label>
                            <input type="time" name="hora_cita" id="hora_cita" class="form-control" required min="08:00" max="18:00" step="1800">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="motivo" class="form-label">Motivo de consulta</label>
                        <textarea name="motivo" id="motivo" class="form-control" rows="5" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Método de Pago -->
            <div class="card mt-4 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Método de Pago</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="monto_consulta" class="form-label">Monto de la consulta ($)</label>
                            <input type="number" name="monto_consulta" id="monto_consulta" 
                                   class="form-control" step="0.01" min="0" value="{{ medico_precio|default:'' }}" readonly required>
                            <small class="form-text text-muted">Se define según el médico.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Método de pago</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="metodo_pago" id="efectivo" value="efectivo" required>
                                <label class="form-check-label" for="efectivo">Efectivo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="metodo_pago" id="tarjeta" value="tarjeta" required>
                                <label class="form-check-label" for="tarjeta">Tarjeta de crédito/débito</label>
                            </div>
                        </div>
                    </div>

                    <!-- Campos de tarjeta -->
                    <div id="campos-tarjeta" class="mt-4" style="display: none;">
                        <h6 class="text-primary mb-3">Datos de la tarjeta</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="numero_tarjeta" class="form-label">Número</label>
                                <input type="text" name="numero_tarjeta" id="numero_tarjeta" class="form-control" maxlength="16" placeholder="1234567890123456">
                            </div>
                            <div class="col-md-3">
                                <label for="fecha_expiracion" class="form-label">Expira</label>
                                <input type="text" name="fecha_expiracion" id="fecha_expiracion" class="form-control" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div class="col-md-3">
                                <label for="cvv" class="form-label">CVV</label>
                                <input type="text" name="cvv" id="cvv" class="form-control" maxlength="4" placeholder="123">
                            </div>
                            <div class="col-md-6">
                                <label for="nombre_titular" class="form-label">Titular</label>
                                <input type="text" name="nombre_titular" id="nombre_titular" class="form-control" placeholder="Como aparece en la tarjeta">
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_tarjeta" class="form-label">Tipo</label>
                                <select name="tipo_tarjeta" id="tipo_tarjeta" class="form-control">
                                    <option value="">Seleccionar...</option>
                                    <option value="debito">Débito</option>
                                    <option value="credito">Crédito</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3" id="info-efectivo" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        Para pago en efectivo, se realiza al momento de la cita.
                    </div>

                    <!-- Resumen -->
                    <div class="alert alert-secondary mt-3">
                        <h6 class="mb-1">Resumen:</h6>
                        <ul class="mb-0">
                            <li><strong>Médico:</strong> <span id="resumen-medico">-</span></li>
                            <li><strong>Fecha:</strong> <span id="resumen-fecha">-</span></li>
                            <li><strong>Hora:</strong> <span id="resumen-hora">-</span></li>
                        </ul>
                    </div>

                    <button type="submit" class="btn btn-success w-100 py-2 mt-3" id="btn-confirmar">
                        <i class="fas fa-calendar-check me-2"></i> Confirmar Cita y Pago
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// --- JavaScript incluido en el template ---
document.addEventListener('DOMContentLoaded', function () {
    const medicoInput = document.getElementById('medico_id');
    const medicoTexto = document.getElementById('medico-seleccionado-texto');
    const montoInput = document.getElementById('monto_consulta');
    const alertaPrecio = document.getElementById('alerta-precio');
    const resumenMedico = document.getElementById('resumen-medico');
    const resumenFecha = document.getElementById('resumen-fecha');
    const resumenHora = document.getElementById('resumen-hora');

    // ✅ Si ya hay un médico cargado desde Django, actualizamos el resumen automáticamente
    const medicoNombre = "{{ medico_nombre|escapejs }}";
    if (medicoNombre) {
        resumenMedico.textContent = medicoNombre;
    }


    // Seleccionar médico
    document.querySelectorAll('.seleccionar-medico').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            const id = btn.dataset.id;
            const nombre = btn.dataset.nombre;
            const precio = btn.dataset.precio;

            medicoInput.value = id;
            medicoTexto.innerHTML = `<strong>${nombre}</strong>`;
            resumenMedico.textContent = nombre;

            if (precio) {
                montoInput.value = precio;
                alertaPrecio.classList.add('d-none');
            } else {
                montoInput.value = '';
                alertaPrecio.textContent = 'Este médico no ha configurado un precio.';
                alertaPrecio.classList.remove('d-none');
            }
        });
    });


    // Validar fecha
    const fechaInput = document.getElementById('fecha_cita');
    fechaInput.addEventListener('change', function () {
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const seleccion = new Date(this.value);
        seleccion.setHours(0, 0, 0, 0);
        if (seleccion < hoy) {
            alert('No puede seleccionar una fecha pasada');
            this.value = '';
        } else {
            resumenFecha.textContent = this.value;
        }
    });

    document.getElementById('hora_cita').addEventListener('change', e => {
        resumenHora.textContent = e.target.value;
    });

    // Métodos de pago
    document.querySelectorAll('input[name="metodo_pago"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const camposTarjeta = document.getElementById('campos-tarjeta');
            const infoEfectivo = document.getElementById('info-efectivo');
            if (this.value === 'tarjeta') {
                camposTarjeta.style.display = 'block';
                infoEfectivo.style.display = 'none';
                document.querySelectorAll('#campos-tarjeta input, #campos-tarjeta select').forEach(f => f.required = true);
            } else {
                camposTarjeta.style.display = 'none';
                infoEfectivo.style.display = 'block';
                document.querySelectorAll('#campos-tarjeta input, #campos-tarjeta select').forEach(f => f.required = false);
            }
        });
    });

    // Validar formato de tarjeta
    document.getElementById('fecha_expiracion').addEventListener('input', e => {
        let v = e.target.value.replace(/\D/g, '');
        if (v.length >= 2) v = v.slice(0, 2) + '/' + v.slice(2, 4);
        e.target.value = v;
    });

    ['numero_tarjeta', 'cvv'].forEach(id => {
        document.getElementById(id).addEventListener('input', e => {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
    });
});
</script>

<style>

/* El contenedor del formulario ahora ocupa todo el ancho */
.container {
    width: 700%;
    border-radius: 10px;
     padding-left: 250px
    
}

.h2{
    text-align=center;
}

/* Secciones del formulario */
.card {
    margin-bottom: 25px;
    border: none;
    border-radius: 10px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

/* Ajusta los inputs */
input, select, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

textarea { resize: none; }

button {
    display: block;
    width: 100%;
    margin-top: 20px;
    border-radius: 8px;
    padding: 10px;
}

input:invalid, textarea:invalid {
    border-color: #dc3545;
}
</style>


{% endblock %}
