{% extends 'medico/dashboard_base.html' %}
{% load static %}

{% block content %}
<main id="main-content" class="flex-grow-1 px-md-5 py-4">
  <div class="container">

    <div class="text-center mb-4">
      <h2 class="mb-3">🏥 Configuración de Clínica</h2>
      <img src="{% static 'img/logo.png' %}" alt="Logo DocLink" width="60" class="mb-3">
      <p class="text-muted">Edita la información general de tu clínica.</p>
    </div>

    <form method="post" class="card p-4 shadow-sm">
      {% csrf_token %}

      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre Clínica</label>
        <input type="text" class="form-control" id="nombre" name="nombre"
               value="{{ request.user.fk_medico.fk_clinica.nombre }}" required>
      </div>

      <div class="mb-3">
        <label for="direccion" class="form-label">Dirección</label>
        <textarea class="form-control" id="direccion" name="direccion" rows="2" required>{{ request.user.fk_medico.fk_clinica.direccion }}</textarea>
      </div>

      <div class="mb-3">
        <label for="telefono_clinica" class="form-label">Teléfono</label>
        <input type="text" class="form-control" id="telefono_clinica" name="telefono_clinica"
               value="{{ request.user.fk_medico.fk_clinica.telefono_clinica }}">
      </div>

      <div class="mb-3">
        <label for="correo_electronico_clinica" class="form-label">Correo Electrónico</label>
        <input type="email" class="form-control" id="correo_electronico_clinica" name="correo_electronico_clinica"
               value="{{ request.user.fk_medico.fk_clinica.correo_electronico_clinica }}">
      </div>

      <div class="mb-3">
        <label for="sitio_web" class="form-label">Sitio Web</label>
        <input type="url" class="form-control" id="sitio_web" name="sitio_web"
               value="{{ request.user.fk_medico.fk_clinica.sitio_web }}">
      </div>

      <div class="mb-3">
        <label for="facebook" class="form-label">Facebook</label>
        <input type="text" class="form-control" id="facebook" name="facebook"
               value="{{ request.user.fk_medico.fk_clinica.facebook }}">
      </div>

      <div class="mb-3">
        <label for="instagram" class="form-label">Instagram</label>
        <input type="text" class="form-control" id="instagram" name="instagram"
               value="{{ request.user.fk_medico.fk_clinica.instagram }}">
      </div>

      <!-- Campos ocultos para coordenadas -->
      <input type="hidden" id="latitud" name="latitud" value="{{ request.user.fk_medico.fk_clinica.latitud|default:'' }}">
      <input type="hidden" id="longitud" name="longitud" value="{{ request.user.fk_medico.fk_clinica.longitud|default:'' }}">

      <!-- Mapa con OpenStreetMap -->
      <div class="mb-3">
        <label class="form-label">Ubicación en el mapa</label>
        <div id="map" style="height: 300px; width: 100%;"></div>
        <small class="form-text text-muted">Haz clic en el mapa para seleccionar la ubicación de tu clínica.</small>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'clinica_doctor' %}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
      </div>
    </form>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      let map;
      let marker;

      function initMap() {
        try {
          // Coordenadas desde Django (None se convierte en null en JSON)
          const savedLat = {{ request.user.fk_medico.fk_clinica.latitud|default:'null' }};
          const savedLng = {{ request.user.fk_medico.fk_clinica.longitud|default:'null' }};

          // Coordenadas por defecto (El Salvador)
          const defaultLat = 13.7942;
          const defaultLng = -88.8965;

          let initialLat = (savedLat !== null && !isNaN(savedLat)) ? savedLat : defaultLat;
          let initialLng = (savedLng !== null && !isNaN(savedLng)) ? savedLng : defaultLng;

          // Inicializar mapa con OpenStreetMap
          map = L.map('map').setView([initialLat, initialLng], 12);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);

          // Agregar marcador
          marker = L.marker([initialLat, initialLng]).addTo(map);

          // Al hacer clic en el mapa
          map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            // Mover marcador
            marker.setLatLng([lat, lng]);

            // Actualizar campos ocultos
            document.getElementById('latitud').value = lat;
            document.getElementById('longitud').value = lng;

            // Geocoding inverso con Nominatim (OpenStreetMap)
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
              .then(response => response.json())
              .then(data => {
                if (data && data.display_name) {
                  document.getElementById('direccion').value = data.display_name;
                }
              })
              .catch(error => console.log('Error en geocoding:', error));
          });

          console.log('Mapa inicializado correctamente con coords:', initialLat, initialLng);
        } catch (error) {
          console.error('Error inicializando mapa:', error);
        }
      }

      // Inicializar mapa cuando se carga la página
      document.addEventListener('DOMContentLoaded', function() {
        initMap();
      });
    </script>

  </div>
</main>
{% endblock %}
