{% extends 'medico/dashboard_base.html' %}
{% load static %}

{% block content %}
<main id="main-content" class="flex-grow-1 px-md-5 py-4">
  <div class="container">

    <div class="text-center mb-4">
      <h2 class="mb-3">üë®‚Äç‚öïÔ∏è Configuraci√≥n del Perfil M√©dico</h2>
      <img src="{% static 'img/logo.png' %}" alt="Logo DocLink" width="60" class="mb-3">
      <p class="text-muted">Edita tu informaci√≥n profesional y de atenci√≥n m√©dica.</p>
    </div>

    <form method="post" class="card p-4 shadow-sm">
      {% csrf_token %}

      <h4 class="mb-3">Informaci√≥n Personal</h4>

      <div class="row">
        <div class="col-md-6 mb-3">
          {{ form.nombre.label_tag }}
          {{ form.nombre }}
          {% if form.nombre.errors %}
            <div class="text-danger">{{ form.nombre.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.apellido.label_tag }}
          {{ form.apellido }}
          {% if form.apellido.errors %}
            <div class="text-danger">{{ form.apellido.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          {{ form.correo.label_tag }}
          {{ form.correo }}
          {% if form.correo.errors %}
            <div class="text-danger">{{ form.correo.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.telefono.label_tag }}
          {{ form.telefono }}
          {% if form.telefono.errors %}
            <div class="text-danger">{{ form.telefono.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          {{ form.departamento.label_tag }}
          {{ form.departamento }}
          {% if form.departamento.errors %}
            <div class="text-danger">{{ form.departamento.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.municipio.label_tag }}
          {{ form.municipio }}
          {% if form.municipio.errors %}
            <div class="text-danger">{{ form.municipio.errors }}</div>
          {% endif %}
        </div>
      </div>

      <h4 class="mb-3 mt-4">Foto de Perfil</h4>

      <div class="mb-3 text-center">
        <div class="mb-3">
          {% if user.foto_perfil %}
            <img id="preview" src="data:image/jpeg;base64,{{ user.foto_perfil }}" alt="Foto de perfil actual" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
          {% else %}
            <img id="preview" src="https://via.placeholder.com/150x150/e9ecef/6c757d?text=Sin+Foto" alt="Foto de perfil predeterminada" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
          {% endif %}
        </div>
        <div class="mb-3">
          <label for="photoInput" class="form-label">
            <i class="fas fa-camera"></i> Editar foto de perfil
          </label>
          <input type="file" id="photoInput" accept="image/*" class="form-control">
          {{ form.foto_perfil }}
          {% if form.foto_perfil.errors %}
            <div class="text-danger">{{ form.foto_perfil.errors }}</div>
          {% endif %}
          <small class="form-text text-muted">Formatos permitidos: JPG, PNG. Tama√±o m√°ximo: 5MB</small>
        </div>
      </div>

      <h4 class="mb-3 mt-4">Informaci√≥n Profesional</h4>

      <div class="mb-3">
        {{ form.especialidad.label_tag }}
        {{ form.especialidad }}
        {% if form.especialidad.errors %}
          <div class="text-danger">{{ form.especialidad.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          {{ form.sub_especialidad_1.label_tag }}
          {{ form.sub_especialidad_1 }}
          {% if form.sub_especialidad_1.errors %}
            <div class="text-danger">{{ form.sub_especialidad_1.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.sub_especialidad_2.label_tag }}
          {{ form.sub_especialidad_2 }}
          {% if form.sub_especialidad_2.errors %}
            <div class="text-danger">{{ form.sub_especialidad_2.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          {{ form.no_jvpm.label_tag }}
          {{ form.no_jvpm }}
          {% if form.no_jvpm.errors %}
            <div class="text-danger">{{ form.no_jvpm.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.dui.label_tag }}
          {{ form.dui }}
          {% if form.dui.errors %}
            <div class="text-danger">{{ form.dui.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="mb-3">
        {{ form.descripcion.label_tag }}
        {{ form.descripcion }}
        {% if form.descripcion.errors %}
          <div class="text-danger">{{ form.descripcion.errors }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        {{ form.precio_consulta.label_tag }}
        {{ form.precio_consulta }}
        {% if form.precio_consulta.errors %}
          <div class="text-danger">{{ form.precio_consulta.errors }}</div>
        {% endif %}
        {% if form.precio_consulta.help_text %}
          <small class="form-text text-muted">{{ form.precio_consulta.help_text }}</small>
        {% endif %}
      </div>

      <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'clinica_doctor' %}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
      </div>
    </form>

  </div>
</main>

<script>
  document.getElementById('photoInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64 = e.target.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
        document.getElementById('preview').src = e.target.result;
        document.getElementById('{{ form.foto_perfil.id_for_label }}').value = base64;
      };
      reader.readAsDataURL(file);
    }
  });
</script>
{% endblock %}
